{% extends "../base.html" %}

{% block title %}MyTask{% end %}

{% block body%}
    <div class="container stack_container" style="width: 960px;">
        <div class="panel sheet project active">
            <header>
                <div class="header_links">
                    <a href="/project/{{project.id}}/accesses">
                        <span class="link">成员邀请</span><br>
                        <span class="detail">
                            个项目成员
                        </span>
                    </a>
                    <a href="/project/{{project.id}}/summary">
                        <span class="link">项目日志</span><br>
                        <span class="detail">最近没有修改</span>
                    </a>
                </div>
                <div data-behavior="edit_project_header expandable">
                    <div class="collapsed_content">
                        <div class="position_reference">
                            <h1 class="field" data-behavior="editable_field_prompt">
                                {{project.title}}
                            </h1>
                        </div>
                        <div class="description field" data-behavior="editable_field_prompt" style="border-color: transparent; width: auto;">
                            {{project.description}}
                        </div>
                    </div>
                </div>
                <div id="project_toolbar" class="project_toolbar" data-autoview="">
                    <div class="tools has_tools_in_project">
                        <div class="group in_project">
                            <a href="/project/{{project.id}}/topics" data-tool-name="topics">
                                <span class=""><strong>{{project.discussionNum}} Discussions</strong></span>
                            </a>
                            <a href="/project/{{project.id}}/todolists" data-tool-name="todolists">
                                <span class=""><strong>{{project.todoNum}} To-dos</strong></span>
                            </a>
                            <a href="/project/{{project.id}}/attachments" data-tool-name="attachments">
                                <span class=""><strong>{{project.fileNum}} Files</strong></span>
                            </a>
                            <a href="/project/{{project.id}}/documents" data-tool-name="documents">
                                <span class=""><strong>{{project.documentNum}} Text documents</strong></span>
                            </a>
                            <a href="/project/{{project.id}}/calendar_events" data-tool-name="calendar_events">
                                <span class=""><strong>Dates</strong></span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="sheet_body">
                <section class="topics">
                    <header class="has_buttons">
                        <h1>
                            <a href="/project/{{project.id}}/topics">讨论</a>
                        </h1>
                        <a class="action_button button" href="/project/{{project.id}}/message/new">发起新讨论</a>
                    </header>
                    <table class="inbox">
                        <tbody>
                            {% for message in messages %}
                            <tr class="topic message" id="topic_{{message.id}}">
                                <td class="avatar">
                                    <a href="/project/{{project.id}}/message/{{message.id}}">
                                        <img class="avatar" height="30" src="/avatar/{{message.own.avatar}}" title="{{message.own.name}}" width="30">
                                    </a>
                                </td>
                                <td class="who">
                                    <a href="/project/{{project.id}}/message/{{message.id}}">{{message.own.name}}</a>
                                </td>
                                <td class="what">
                                    <a href="/project/{{project.id}}/message/{{message.id}}">
                                        <strong>{{message.title}}</strong>
                                        <span class="excerpt">{{message.content}}<span>
                                    </a>
                                </td>
                                <td class="when">
                                    <a href="/project/{{project.id}}/message/{{message.id}}">
                                        <time data-compact="" datetime="2013-03-19T09:36:42Z" style="">{{message.createTime}}</time>
                                    </a>
                                </td>
                            </tr>
                            {% end %}
                        </tbody>
                    </table>
                    {% if project.discussionNum > 5 %}
                    <p class="more_topics">
                        <a class="decorated" href="/project/{{project.id}}/topic">{{project.discussionNum - 5}} more discussions</a>
                    </p>
                    {% end %}
                </section>


                <section class="todos">
                    <header class="has_buttons">
                        <h1>
                            <a href="/project/{{project.id}}/todolist">任务列表</a>
                        </h1>
                        <a class="action_button button btn" data-toggle="button-display" href="javascript:;" 
                            data-content="#new_todoList_article">添加任务列表</a>
                    </header>
                    <article class="todolist new expanded" id="new_todoList_article" style="display:none">
                        <header class="expanded_content">
                            <form action="/project/{{project.id}}/todolist" class="new_todolist" id="new_todolist" method="post">
                                <header class="text_entry">
                                    <h3>
                                        <input id="todolist_name" data-toggle="remote" name="title" size="10" type="text" placeholder="给任务列表起个名字">
                                    </h3>
                                </header>
                                <p class="submit">
                                    <button name="commit" data-toggle="submit" >保存，开始添加任务</button> or
                                    <a class="cancel btn" data-toggle="button-display"  
                                        data-content="#new_todoList_article" href="javascript:;">取消</a>
                                </p>
                            </form>
                        </header>
                    </article>
                    <ul class="todolists ui-sortable" id="todolists_container">
                        {% for todolist in todolists %}
                        <li data-behavior="sortable" data-sortable-type="todolist" id="sortable_todolist">
                            <article class="todolist">
                                <header class="collapsed_content" data-behavior="has_hover_content">
                                    <div class="nubbin" data-behavior="nubbin hover_content" style="display: none; left: -62px;">
                                        <div class="spacer"></div>
                                        <a class="image delete" data-confirm="Are you sure you want to delete this to-do list?" 
                                            data-method="post" data-remote="true" href="/project/{{project.id}}/todolist//trash" rel="nofollow">Delete</a>
                                        <a class="edit" data-behavior="edit" href="#">Edit</a>
                                    </div>
                                    <h3 data-behavior="sortable_handle">
                                        <a class="linked_title" href="/project/{{project.id}}/todolist/">
                                            {{ todolist.title}}
                                        </a>
                                    </h3>
                                    <p><em>{{ todolist.description}}</em></p>
                                </header>
                                <ul class="todos">
                                    {% for todoItem in todolist.todoItems %}
                                    <li class="todo show" data-behavior="has_hover_content">
                                        <div class="nubbin" data-behavior="nubbin hover_content" style="display: none; left: -62px;">
                                            <div class="spacer"></div>
                                            <a class="image delete" data-confirm="Are you sure you want to delete this to-do?" data-method="post" 
                                                data-remote="true" href="/project/{{project.id}}//trash" rel="nofollow">Delete</a>
                                            <a class="edit" data-remote="true" 
                                                data-url="/project/{{project.id}}/todo//edit" href="#">Edit</a>
                                        </div>
                                        <div>
                                            <span class="wrapper">
                                                <input data-behavior="toggle" 
                                                    data-url="/project/{{project.id}}/todo//toggle" name="todo_complete" type="checkbox" value="1">
                                                <span class="content" data-behavior="sortable_handle">
                                                    <a href="/project/{{project.id}}/todo/">
                                                        {{ todoItem.description }}
                                                    </a>
                                                </span>
                                                <form action="/project/{{project.id}}/todo/{{todoItem.id}}" class="edit_todo" 
                                                    data-remote="true" id="edit_todo_41824572" method="post">
                                                    <span style="position:relative">
                                                        <span class="pill has_balloon blank showing exclusively_expanded expanded"
                                                            data-toggle="popover" data-conent="#tpl-todo-popover"
                                                            data-hovercontent-strategy="visibility">
                                                            <a class="popover-btn" cla href="javascript:;"  data-toggle="popover" data-conent="#tpl-todo-popover">
                                                                <span data-behavior="assignee_name" data-blank-text="Unassigned">
                                                                    unassigned
                                                                </span>
                                                                <time data-behavior="due_date" data-blank-text="No due date">
                                                                </time>
                                                            </a>
                                                        </span>
                                                    </span>
                                                </form>
                                            </span>
                                        </div>
                                    </li>
                                    {% end %}
                                </ul>

                                <ul class="new expanded">
                                    <li class="collapsed_content">
                                        <a class="decorated btn" data-toggle="button-display" id="trigger_todoList_{{todolist.id}}" 
                                            data-content="#new_todoitem_{{todolist.id}}" data-hidden="#trigger_todoList_{{todolist.id}}" 
                                            href="javascript:;">
                                            添加任务
                                        </a>
                                    </li>
                                    <li class="expanded_content edit_mode">
                                        <form action="/project/{{project.id}}/todolist/{{todolist.id}}/todoitem" class="new_todo" 
                                            data-behavior="new_todo" data-remote="true" id="new_todoitem_{{todolist.id}}" 
                                            style="display:none" method="post">
                                            <textarea data-behavior="autoresize submit_on_enter" id="todo_content" 
                                                name="description" placeholder="Add a new to-do" rows="1" data-toggle="remote"
                                                data-autoresize="true" style="resize: none; overflow: hidden; min-height: 18px;"></textarea>
                                            <span style="position:relative">
                                                <span class="pill has_balloon blank ignore_hover"> 
                                                    <a data-behavior="expand_on_click" href="#">
                                                        <span data-behavior="assignee_name" data-blank-text="Unassigned">
                                                          Unassigned
                                                        </span>
                                                
                                                        <span class="separator"> · </span>
                                                
                                                        <time data-behavior="due_date" data-blank-text="No due date">
                                                          No due date
                                                        </time>
                                                    </a>
                                                </span>
                                            </span>
                                            <p class="submit">
                                                <input name="commit" type="submit" value="Add this to-do"> or
                                                <a class="cancel btn" data-behavior="cancel" data-role="cancel" href="javascript:;"
                                                    data-toggle="button-display" data-content="#new_todoitem_{{todolist.id}}" 
                                                    data-hidden="#trigger_todoList_{{todolist.id}}" >
                                                    取消
                                                </a>
                                            </p>
                                        </form>
                                    </li>
                                </ul>
                            </article>
                        </li>
                        {% end %}
                    </ul>
            </div>
        </div>
    </div>

<div class="popover direction-right-top" style="display: none" id="tpl-todo-popover">
    <div class="popover-content">
        <div class="assign-due-popover">
        	<div class="select-assignee">
        		<h3>将任务指派给</h3>
        		<select tabindex="62" name="workerId" class="todo-assignee" >
                    {% for member in project.users %}
                    <option value="{{member.id}}">{{member.name}}</option>
                    {% end %}
        	  </select>
        	</div>
        	<div class="select-due-date">
        		<h3>任务截止时间</h3>
        		<div class="datepicker" id="todo-popover-datapicker">
        			<input type="hidden" class="todo-due-date" />
        		</div>
        		<div class="no-due-date">
        			<a href="javascript:;">没有截止时间</a>
        		</div>
        	</div>
        </div>
    </div>
    <div class="popover-arrow"></div>
</div>
{% end %}

{% block script %}
$(function(){
    function doReponseTodoList(responseData) {
        var contentStr = '<li data-behavior="sortable" data-sortable-type="todolist" id="sortable_todolist">'
            + '<article class="todolist">'
            + '<header class="collapsed_content" data-behavior="has_hover_content">'
            + '<div class="nubbin" data-behavior="nubbin hover_content" style="left: -62px; display: none;">'
            + '<div class="spacer"></div>'
            + '<a class="image delete" data-confirm="Are you sure you want to delete this to-do list?" data-method="post" data-remote="true" href="/project/1/todolist//trash" rel="nofollow">Delete</a>'
            + '<a class="edit" data-behavior="edit" href="#">Edit</a>'
            + '</div>'
            + '<h3 data-behavior="sortable_handle">'
            + '<a class="linked_title" href="/project/' + responseData.projectId + '/todolist/">'
            + 'test'
            + '</a>'
            + '</h3>'
            + '<p><em>None</em></p>'
            + '</header>'
            + '<ul class="todos">'
            + '</ul>'



            + '</article>'
            + '</li>'

        var $todoList = $(contentStr)
        $('#new_todoList_article').toggle()
        $todoList.prependTo('#todolists_container')
    }

    
    $("#new_todolist").data('doResponse', doReponseTodoList)
})

{% end %}
